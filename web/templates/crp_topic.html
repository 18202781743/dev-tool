{% extends "base.html" %}

{% block title %}{{ topic_name }} - 主题详情 - CRP打包管理{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题和导航 -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">首页</a></li>
                    <li class="breadcrumb-item"><a href="/crp">CRP管理</a></li>
                    <li class="breadcrumb-item active">{{ topic_name }}</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-folder-open"></i> {{ topic_name }}</h2>
                    <p class="text-muted">主题打包实例管理</p>
                </div>
                <div>
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#newPackageModal">
                        <i class="bi bi-plus-circle"></i> 新建打包
                    </button>
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#batchPackageModal">
                        <i class="bi bi-collection"></i> 批量打包
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 主题信息卡片 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="card-title mb-3">主题信息</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>主题名称:</strong><br>
                                    <span class="text-muted" id="topicNameDisplay">{{ topic_name }}</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>主题ID:</strong><br>
                                    <span class="text-muted" id="topicIdDisplay">加载中...</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>创建者:</strong><br>
                                    <span class="text-muted" id="topicCreatorDisplay">加载中...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex flex-column">
                                <button class="btn btn-outline-primary btn-sm mb-2" onclick="refreshInstances()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新列表
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="history.back()">
                                    <i class="bi bi-arrow-left"></i> 返回主题列表
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 打包实例列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul"></i> 打包实例列表
                    </h5>
                    <div class="d-flex">
                        <input type="text" class="form-control form-control-sm me-2" id="instanceFilter" 
                               placeholder="搜索项目名称..." style="width: 200px;">
                        <span class="badge bg-info" id="instanceCount">0</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="instancesContainer">
                        <div class="text-center text-muted py-5">
                            <div class="loading mb-3"></div>
                            <p>正在加载打包实例...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新建打包模态框 -->
<div class="modal fade" id="newPackageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> 新建打包任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newPackageForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 将在主题 <strong>{{ topic_name }}</strong> 中创建打包任务
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="packageProject" class="form-label">项目名称 *</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="packageProject" required 
                                       placeholder="输入项目名称，支持模糊搜索" autocomplete="off">
                                <div id="projectSuggestions" class="position-absolute w-100 bg-white border rounded shadow-sm" 
                                     style="top: 100%; z-index: 1050; display: none; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            <div class="form-text">输入2个或更多字符开始搜索</div>
                        </div>
                        <div class="col-md-6">
                            <label for="packageBranch" class="form-label">分支</label>
                            <div class="position-relative">
                                <select class="form-select" id="packageBranch" disabled>
                                    <option value="upstream/master">upstream/master (默认)</option>
                                </select>
                                <div class="form-text">选择项目后加载分支列表</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="packageTag" class="form-label">自定义标签</label>
                            <input type="text" class="form-control" id="packageTag" placeholder="留空自动生成">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">目标架构</label>
                            <div id="architecture-container-package">
                                <!-- 架构列表将从配置动态生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">
                                最新提交信息
                                <span id="commitLoadingSpinner" class="d-none">
                                    <span class="spinner-border spinner-border-sm ms-2" role="status"></span>
                                </span>
                            </label>
                            <div id="latestCommitInfo" class="bg-light p-3 rounded border">
                                <div class="text-center text-muted">
                                    <i class="bi bi-info-circle"></i>
                                    <small class="d-block mt-1">请先选择项目，然后系统将自动获取最新提交信息</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> 创建打包任务
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 批量打包模态框 -->
<div class="modal fade" id="batchPackageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-collection"></i> 批量打包任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="batchPackageForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 将在主题 <strong>{{ topic_name }}</strong> 中批量创建打包任务
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="batchProjects" class="form-label">项目列表</label>
                            <textarea class="form-control" id="batchProjects" rows="10" 
                                      placeholder="每行一个项目名称，例如：&#10;dde-control-center&#10;dde-daemon&#10;dtkgui"></textarea>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">批量设置</label>
                            <div class="mb-3">
                                <label for="batchBranch" class="form-label">统一分支</label>
                                <input type="text" class="form-control" id="batchBranch" value="upstream/master">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">目标架构</label>
                                <div id="architecture-container-batch">
                                    <!-- 架构列表将从配置动态生成 -->
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-info btn-sm" id="checkBatchCommits">
                                <i class="bi bi-search"></i> 检查最新提交
                            </button>
                        </div>
                    </div>
                    
                    <div id="batchCommitInfo" class="d-none">
                        <h6>提交信息预览</h6>
                        <div id="batchCommitList" class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-collection"></i> 批量创建打包任务
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 打包详情模态框 -->
<div class="modal fade" id="instanceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> 打包详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="instanceDetailContent">
                    <div class="text-center">
                        <div class="loading"></div>
                        <p class="mt-2">加载详情中...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTopic = '{{ topic_name }}';  
let projectSuggestions = [];
let allInstances = [];
let crpConfig = null;

document.addEventListener('DOMContentLoaded', function() {
    // 初始化架构列表
    initializeArchitectures();
    
    // 绑定事件
    document.getElementById('newPackageForm').addEventListener('submit', createPackage);
    document.getElementById('batchPackageForm').addEventListener('submit', createBatchPackages);
    document.getElementById('checkBatchCommits').addEventListener('click', checkBatchCommits);
    document.getElementById('instanceFilter').addEventListener('input', debounce(filterInstances, 300));
    
    // 项目输入框事件
    const projectInput = document.getElementById('packageProject');
    projectInput.addEventListener('input', debounce(searchProjects, 300));
    
    // 分支切换事件
    const branchSelect = document.getElementById('packageBranch');
    branchSelect.addEventListener('change', function() {
        const projectName = projectInput.value.trim();
        const selectedBranch = this.value;
        
        if (projectName && selectedBranch) {
            console.log('Branch changed to:', selectedBranch, 'for project:', projectName);
            // 刷新提交信息
            getLatestCommit(projectName, selectedBranch);
        }
    });
    projectInput.addEventListener('focus', function() {
        // 聚焦时如果有值且长度>=2，显示建议
        if (this.value.length >= 2) {
            searchProjects();
        }
    });
    projectInput.addEventListener('blur', function() {
        // 延迟隐藏建议列表，让点击事件先触发
        setTimeout(() => {
            document.getElementById('projectSuggestions').style.display = 'none';
        }, 200);
    });
    
    // 项目输入完成检测（用户停止输入一段时间后）
    let inputFinishTimeout = null;
    projectInput.addEventListener('input', function() {
        clearTimeout(inputFinishTimeout);
        const value = this.value.trim();
        
        if (value.length >= 2) {
            inputFinishTimeout = setTimeout(() => {
                // 检查是否是一个完整的项目名称（不包含空格等）
                if (value && !value.includes(' ') && value.length > 3) {
                    // 检查是否在建议列表中存在精确匹配
                    const suggestions = document.getElementById('projectSuggestions');
                    if (suggestions.style.display === 'none') {
                        // 建议已隐藏，说明用户已选择或输入完成
                        onProjectInputComplete(value);
                    }
                }
            }, 1500); // 1.5秒后认为输入完成
        }
    });
    
    // 隐藏项目建议
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#packageProject') && !e.target.closest('#projectSuggestions')) {
            document.getElementById('projectSuggestions').style.display = 'none';
        }
    });
    
    // 键盘导航支持
    projectInput.addEventListener('keydown', function(e) {
        const suggestions = document.getElementById('projectSuggestions');
        if (suggestions.style.display === 'none') return;
        
        const items = suggestions.querySelectorAll('.suggestion-item');
        let selectedIndex = -1;
        
        // 找到当前选中的项目
        items.forEach((item, index) => {
            if (item.classList.contains('selected')) {
                selectedIndex = index;
            }
        });
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = (selectedIndex + 1) % items.length;
            updateSelectedSuggestion(items, selectedIndex);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
            updateSelectedSuggestion(items, selectedIndex);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            items[selectedIndex].click();
        } else if (e.key === 'Escape') {
            suggestions.style.display = 'none';
        }
    });
    
    // 加载主题信息和实例列表
    loadTopicInfo();
    loadInstances();
});

function updateSelectedSuggestion(items, selectedIndex) {
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.classList.add('selected', 'bg-light');
        } else {
            item.classList.remove('selected', 'bg-light');
        }
    });
}

function onProjectInputComplete(projectName) {
    // 用户完成项目输入，自动获取信息
    if (projectName && projectName.length > 3) {
        // 创建项目数据对象，ID暂时未知
        const projectData = {
            name: projectName,
            id: undefined  // 将在后续调用中动态获取
        };
        onProjectSelected(projectData);
    }
}

function loadTopicInfo() {
    // 从主题列表中获取详细信息（如果需要的话）
    // 这里可以调用API获取更详细的主题信息
    fetch('/api/crp/topics')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const topic = data.topics.find(t => t.Name === currentTopic);
                if (topic) {
                    document.getElementById('topicIdDisplay').textContent = topic.ID || 'N/A';
                    document.getElementById('topicCreatorDisplay').textContent = topic.Creator || '未知';
                }
            }
        })
        .catch(error => {
            console.error('Failed to load topic info:', error);
        });
}

function loadInstances() {
    const container = document.getElementById('instancesContainer');
    container.innerHTML = '<div class="text-center text-muted py-5"><div class="loading mb-3"></div><p>正在加载打包实例...</p></div>';
    
    fetch(`/api/crp/instances/${encodeURIComponent(currentTopic)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allInstances = data.instances;
                displayInstances(allInstances);
                updateInstanceCount(allInstances.length);
            } else {
                container.innerHTML = `<div class="text-center text-danger py-5"><i class="bi bi-exclamation-triangle fs-1"></i><p class="mt-2">${data.message}</p></div>`;
            }
        })
        .catch(error => {
            container.innerHTML = `<div class="text-center text-danger py-5"><i class="bi bi-exclamation-triangle fs-1"></i><p class="mt-2">加载失败: ${error.message}</p></div>`;
        });
}

function displayInstances(instances) {
    const container = document.getElementById('instancesContainer');
    
    if (instances.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-inbox fs-1"></i><p class="mt-2">暂无打包实例</p></div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover mb-0">';
    html += `
        <thead class="table-light">
            <tr>
                <th>项目名称</th>
                <th>分支</th>
                <th>标签</th>
                <th>构建状态</th>
                <th>构建ID</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    instances.forEach(instance => {
        // 处理BuildState，可能是对象或字符串
        let buildState = 'unknown';
        if (instance.BuildState) {
            if (typeof instance.BuildState === 'object') {
                buildState = instance.BuildState.state || instance.BuildState.status || 'unknown';
            } else {
                buildState = instance.BuildState;
            }
        }
        
        const stateClass = getStateClass(buildState);
        const stateBadge = `<span class="badge ${stateClass}">${buildState}</span>`;
        
        html += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-box me-2 text-primary"></i>
                        <div>
                            <div class="fw-semibold">${instance.ProjectName || 'N/A'}</div>
                            <small class="text-muted">ID: ${instance.ProjectID || 'N/A'}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <code class="small">${instance.Branch || 'N/A'}</code>
                </td>
                <td>
                    <span class="badge bg-secondary">${instance.Tag || 'N/A'}</span>
                </td>
                <td>${stateBadge}</td>
                <td>
                    ${instance.BuildID ? `<a href="https://shuttle.uniontech.com/#/tasks/task?taskid=${instance.BuildID}" target="_blank" class="text-decoration-none">${instance.BuildID} <i class="bi bi-box-arrow-up-right"></i></a>` : 'N/A'}
                </td>
                <td>
                    ${instance.BuildID ? `
                        <a href="https://shuttle.uniontech.com/#/tasks/task?taskid=${instance.BuildID}" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-box-arrow-up-right"></i> Shuttle
                        </a>
                    ` : `
                        <span class="text-muted small">暂无构建</span>
                    `}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function getStateClass(state) {
    const stateStr = String(state).toUpperCase();
    
    // 成功状态 - 绿色
    if (['UPLOAD_OK', 'SUCCESS', 'OK'].includes(stateStr)) {
        return 'bg-success';
    } 
    // 失败状态 - 红色
    else if (['UPLOAD_GIVEUP', 'APPLY_FAILED', 'FAILED', 'ERROR'].includes(stateStr)) {
        return 'bg-danger';
    } 
    // 进行中状态 - 黄色/橙色
    else if (['APPLYING', 'UPLOADING', 'BUILDING', 'PENDING', 'RUNNING'].includes(stateStr)) {
        return 'bg-warning text-dark';
    } 
    // 未知或默认状态 - 灰色
    else if (['UNKNOWN', 'NONE', ''].includes(stateStr) || !state) {
        return 'bg-secondary';
    }
    // 其他未识别状态 - 浅灰色
    else {
        return 'bg-light text-dark border';
    }
}

function updateInstanceCount(count) {
    document.getElementById('instanceCount').textContent = count;
}

function filterInstances() {
    const filter = document.getElementById('instanceFilter').value.toLowerCase();
    const filteredInstances = allInstances.filter(instance => 
        (instance.ProjectName || '').toLowerCase().includes(filter)
    );
    displayInstances(filteredInstances);
    updateInstanceCount(filteredInstances.length);
}

function refreshInstances() {
    loadInstances();
}





// 项目搜索功能
let searchTimeout = null;
let projectCache = new Map(); // 缓存项目列表

function searchProjects() {
    const query = document.getElementById('packageProject').value.trim();
    
    // 清除之前的搜索超时
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    if (query.length < 2) {
        document.getElementById('projectSuggestions').style.display = 'none';
        clearProjectInfo();
        return;
    }
    
    // 检查缓存
    if (projectCache.has(query)) {
        showProjectSuggestions(projectCache.get(query));
        return;
    }
    
    // 延迟搜索，避免频繁请求
    searchTimeout = setTimeout(() => {
        fetch(`/api/crp/projects?filter=${encodeURIComponent(query)}&per_page=10`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.projects) {
                    const projects = data.projects; // API已经限制了数量
                    projectCache.set(query, projects); // 缓存结果
                    showProjectSuggestions(projects);
                } else {
                    showProjectSuggestions([]);
                }
            })
            .catch(error => {
                console.error('Search projects failed:', error);
                showProjectSuggestions([]);
            });
    }, 300); // 300ms 延迟
}

function showProjectSuggestions(projects) {
    const container = document.getElementById('projectSuggestions');
    
    if (projects.length === 0) {
        container.innerHTML = '<div class="p-2 text-muted text-center"><small>未找到匹配的项目</small></div>';
        container.style.display = 'block';
        return;
    }
    
    let html = '';
    projects.forEach((project, index) => {
        const isLast = index === projects.length - 1;
        // 转义项目数据用于HTML属性
        const projectData = JSON.stringify({
            id: project.ID,
            name: project.Name,
            description: project.Description || '',
            repoUrl: project.RepoUrl || ''
        }).replace(/"/g, '&quot;');
        
        html += `
            <div class="suggestion-item p-2 ${!isLast ? 'border-bottom' : ''}" onclick="selectProject(this)" data-project="${projectData}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="fw-semibold text-primary">${project.Name}</div>
                        ${project.Description ? `<small class="text-muted d-block">${project.Description}</small>` : ''}
                    </div>
                    <div class="ms-2">
                        <i class="bi bi-box text-muted"></i>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    container.style.display = 'block';
}

function selectProject(element) {
    const projectData = JSON.parse(element.getAttribute('data-project').replace(/&quot;/g, '"'));
    const input = document.getElementById('packageProject');
    
    input.value = projectData.name;
    input.setAttribute('data-project-id', projectData.id);
    document.getElementById('projectSuggestions').style.display = 'none';
    
    // 触发项目选择后的操作
    onProjectSelected(projectData);
}

function onProjectSelected(projectData) {
    // 先获取分支列表，分支加载完成后会自动刷新提交信息
    getBranchList(projectData.id, projectData.name).then(() => {
        console.log('Project info loaded for:', projectData.name);
    }).catch(error => {
        console.error('Failed to load project info:', error);
        // 如果分支加载失败，至少尝试获取默认分支的提交信息
        getLatestCommit(projectData.name, 'upstream/master');
    });
}

function getLatestCommit(projectName, branch = 'upstream/master') {
    const infoDiv = document.getElementById('latestCommitInfo');
    const spinner = document.getElementById('commitLoadingSpinner');
    
    // 显示加载状态
    spinner.classList.remove('d-none');
    infoDiv.innerHTML = `
        <div class="text-center text-muted">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <small>正在获取 <strong>${projectName}</strong> 在分支 <strong>${branch}</strong> 的最新提交信息...</small>
        </div>
    `;
    
    // 调用API获取最新提交信息
    fetch(`/api/crp/latest-commit?project=${encodeURIComponent(projectName)}&branch=${encodeURIComponent(branch)}`)
        .then(response => response.json())
        .then(data => {
            spinner.classList.add('d-none');
            if (data.success && data.commit) {
                const commit = data.commit;
                infoDiv.innerHTML = `
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-git me-2 text-primary"></i>
                                <strong>最新提交</strong>
                            </div>
                            <div class="small text-muted">
                                <div class="mb-1">
                                    <strong>提交哈希:</strong> 
                                    <code class="small">${commit.hash || 'N/A'}</code>
                                </div>
                                <div class="mb-1">
                                    <strong>提交时间:</strong> ${commit.date || 'N/A'}
                                </div>
                                <div>
                                    <strong>作者:</strong> ${commit.author || 'N/A'}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-chat-left-text me-2 text-success"></i>
                                <strong>提交信息</strong>
                            </div>
                            <div class="small bg-white p-2 rounded border">
                                ${commit.message || 'No commit message'}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                infoDiv.innerHTML = `
                    <div class="text-center text-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <small class="d-block mt-1">${data.message || '无法获取提交信息'}</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            spinner.classList.add('d-none');
            infoDiv.innerHTML = `
                <div class="text-center text-danger">
                    <i class="bi bi-exclamation-circle"></i>
                    <small class="d-block mt-1">获取提交信息失败: ${error.message}</small>
                </div>
            `;
        });
}

function getBranchList(projectId, projectName) {
    const branchSelect = document.getElementById('packageBranch');
    
    // 显示加载状态
    branchSelect.disabled = true;
    branchSelect.innerHTML = '<option>正在加载分支列表...</option>';
    
    // 如果没有项目ID，先搜索项目获取ID
    if (!projectId || projectId === 'undefined') {
        console.log('Project ID not available, searching for project:', projectName);
        return fetch(`/api/crp/projects?filter=${encodeURIComponent(projectName)}&per_page=5`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.projects && data.projects.length > 0) {
                    // 寻找精确匹配的项目
                    const exactMatch = data.projects.find(p => p.Name === projectName);
                    if (exactMatch) {
                        // 找到项目，获取分支
                        return getBranchList(exactMatch.ID, projectName);
                    }
                }
                // 没有找到项目，使用默认分支
                branchSelect.disabled = false;
                branchSelect.innerHTML = '<option value="upstream/master" selected>upstream/master (默认)</option>';
                if (projectName) {
                    getLatestCommit(projectName, 'upstream/master');
                }
                return Promise.resolve();
            })
            .catch(error => {
                branchSelect.disabled = false;
                branchSelect.innerHTML = '<option value="upstream/master" selected>upstream/master (默认)</option>';
                console.error('Failed to search project:', error);
                return Promise.reject(error);
            });
    }
    
    // 调用API获取分支列表
    return fetch(`/api/crp/projects/${projectId}/branches`)
        .then(response => response.json())  
        .then(data => {
            branchSelect.disabled = false;
            if (data.success && data.branches && data.branches.length > 0) {
                let html = '';
                let defaultBranchName = null;
                
                data.branches.forEach((branch, index) => {
                    const isDefault = branch.Name === 'master' || branch.Name === 'upstream/master' || index === 0;
                    if (isDefault && !defaultBranchName) {
                        defaultBranchName = branch.Name;
                    }
                    html += `<option value="${branch.Name}"${isDefault ? ' selected' : ''}>${branch.Name}</option>`;
                });
                
                branchSelect.innerHTML = html;
                
                // 分支加载完成后，用选中的分支刷新提交信息
                if (defaultBranchName && projectName) {
                    console.log('Auto-refreshing commit info for default branch:', defaultBranchName);
                    getLatestCommit(projectName, defaultBranchName);
                }
            } else {
                branchSelect.innerHTML = '<option value="upstream/master" selected>upstream/master (默认)</option>';
                // 即使没有分支，也尝试获取默认分支的提交信息
                if (projectName) {
                    getLatestCommit(projectName, 'upstream/master');
                }
            }
        })
        .catch(error => {
            branchSelect.disabled = false;
            branchSelect.innerHTML = '<option value="upstream/master" selected>upstream/master (默认)</option>';
            console.error('Failed to load branches:', error);
            throw error;
        });
}

function clearProjectInfo() {
    const infoDiv = document.getElementById('latestCommitInfo');
    const branchSelect = document.getElementById('packageBranch');
    const spinner = document.getElementById('commitLoadingSpinner');
    
    spinner.classList.add('d-none');
    infoDiv.innerHTML = `
        <div class="text-center text-muted">
            <i class="bi bi-info-circle"></i>
            <small class="d-block mt-1">请先选择项目，然后系统将自动获取最新提交信息</small>
        </div>
    `;
    
    branchSelect.disabled = true;
    branchSelect.innerHTML = '<option value="upstream/master">upstream/master (默认)</option>';
}

function createPackage(e) {
    e.preventDefault();
    
    const projectName = document.getElementById('packageProject').value;
    const branch = document.getElementById('packageBranch').value;
    const tag = document.getElementById('packageTag').value;
    
    // 获取选中的架构
    const archs = [];
    document.querySelectorAll('input[id^="arch-"]:checked').forEach(checkbox => {
        archs.push(checkbox.value);
    });
    
    if (!projectName) {
        showAlert('请输入项目名称', 'warning');
        return;
    }
    
    const submitBtn = document.querySelector('#newPackageForm button[type="submit"]');
    const hideLoading = showLoading(submitBtn, '创建中...');
    
    fetch('/api/crp/package', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            topic: currentTopic,
            project: projectName,
            branch: branch,
            archs: archs,
            tag: tag
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert('打包任务创建成功！', 'success');
            bootstrap.Modal.getInstance(document.getElementById('newPackageModal')).hide();
            document.getElementById('newPackageForm').reset();
            loadInstances(); // 刷新列表
        } else {
            showAlert('创建失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('创建失败: ' + error.message, 'danger');
    });
}

function createBatchPackages(e) {
    e.preventDefault();
    
    const projectsText = document.getElementById('batchProjects').value;
    const projects = projectsText.split('\n').map(p => p.trim()).filter(p => p);
    
    if (projects.length === 0) {
        showAlert('请输入至少一个项目名称', 'warning');
        return;
    }
    
    const batch = projects.map(name => ({
        name: name,
        branch: document.getElementById('batchBranch').value,
        archs: Array.from(document.querySelectorAll('input[id^="batch-arch-"]:checked')).map(cb => cb.value)
    }));
    
    const submitBtn = document.querySelector('#batchPackageForm button[type="submit"]');
    const hideLoading = showLoading(submitBtn, '批量创建中...');
    
    fetch('/api/crp/batch-package', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            topic: currentTopic,
            packages: batch
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(`批量打包任务创建完成！共 ${projects.length} 个项目`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('batchPackageModal')).hide();
            document.getElementById('batchPackageForm').reset();
            loadInstances(); // 刷新列表
        } else {
            showAlert('批量创建失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('批量创建失败: ' + error.message, 'danger');
    });
}

function checkBatchCommits() {
    // 检查批量提交信息
    const projectsText = document.getElementById('batchProjects').value;
    const projects = projectsText.split('\n').map(p => p.trim()).filter(p => p);
    
    if (projects.length === 0) {
        showAlert('请先输入项目列表', 'warning');
        return;
    }
    
    const infoDiv = document.getElementById('batchCommitInfo');
    const listDiv = document.getElementById('batchCommitList');
    
    infoDiv.classList.remove('d-none');
    listDiv.innerHTML = '<div class="loading"></div> 检查提交信息中...';
    
    // 这里可以并发检查所有项目的最新提交
    setTimeout(() => {
        let html = '';
        projects.forEach(project => {
            html += `
                <div class="mb-2 p-2 border rounded">
                    <strong>${project}</strong><br>
                    <small class="text-muted">最新提交: abc123 - fix: update something (2025-09-26)</small>
                </div>
            `;
        });
        listDiv.innerHTML = html;
    }, 2000);
}

// 架构管理函数
async function initializeArchitectures() {
    try {
        const response = await fetch('/api/crp/config');
        const data = await response.json();
        
        if (data.success) {
            crpConfig = data.config;
            const architectures = crpConfig.defaultArchs || ['amd64', 'arm64', 'loong64', 'sw64', 'mips64el'];
            
            // 生成单个包装架构选择
            generateArchitectureCheckboxes('architecture-container-package', architectures, 'arch-');
            
            // 生成批量打包架构选择
            generateArchitectureCheckboxes('architecture-container-batch', architectures, 'batch-arch-');
        } else {
            console.error('Failed to load CRP config:', data.message);
            // 使用默认架构
            const defaultArchs = ['amd64', 'arm64', 'loong64', 'sw64', 'mips64el'];
            generateArchitectureCheckboxes('architecture-container-package', defaultArchs, 'arch-');
            generateArchitectureCheckboxes('architecture-container-batch', defaultArchs, 'batch-arch-');
        }
    } catch (error) {
        console.error('Error initializing architectures:', error);
        // 使用默认架构
        const defaultArchs = ['amd64', 'arm64', 'loong64', 'sw64', 'mips64el'];
        generateArchitectureCheckboxes('architecture-container-package', defaultArchs, 'arch-');
        generateArchitectureCheckboxes('architecture-container-batch', defaultArchs, 'batch-arch-');
    }
}

function generateArchitectureCheckboxes(containerId, architectures, idPrefix) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    
    architectures.forEach((arch, index) => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = containerId.includes('batch') ? 'form-check' : 'form-check form-check-inline';
        
        const checkbox = document.createElement('input');
        checkbox.className = 'form-check-input';
        checkbox.type = 'checkbox';
        checkbox.id = idPrefix + arch;
        checkbox.value = arch;
        // 默认选中前两个架构
        checkbox.checked = index < 2;
        
        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.setAttribute('for', idPrefix + arch);
        label.textContent = arch;
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        container.appendChild(checkboxDiv);
    });
}

// 工具函数
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showLoading(button, text) {
    const originalText = button.innerHTML;
    button.innerHTML = `<span class="loading-sm me-2"></span>${text}`;
    button.disabled = true;
    
    return function hideLoading() {
        button.innerHTML = originalText;
        button.disabled = false;
    };
}

function showAlert(message, type) {
    // 创建alert元素
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 3秒后自动移除
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}
</script>

<style>
.loading {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

.loading-sm {
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.suggestion-item {
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
}

.suggestion-item:hover,
.suggestion-item.selected {
    background-color: #f8f9fa;
}

.suggestion-item:active {
    background-color: #e9ecef;
}

#projectSuggestions {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: 1px solid #dee2e6;
}

#projectSuggestions:empty::before {
    content: "正在搜索...";
    display: block;
    padding: 0.75rem;
    text-align: center;
    color: #6c757d;
    font-size: 0.875rem;
}

.spinner-border-sm {
    width: 0.875rem;
    height: 0.875rem;
}

.table th {
    border-top: none;
    font-weight: 600;
}
</style>
{% endblock %}